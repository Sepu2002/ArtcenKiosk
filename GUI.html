<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Service Package Locker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Support for Tailwind's dark mode class strategy
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <!-- Simple Keyboard CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/css/index.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .modal-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        html.dark .modal-content {
             background: #1f2937; /* gray-800 */
        }
        .modal-backdrop.active .modal-content {
            transform: scale(1);
        }
        .bay-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        /* Virtual Keyboard Styling */
        #keyboard-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: #2c2c2e;
            padding: 5px;
            display: none; /* Hidden by default */
        }
        .simple-keyboard.hg-theme-default {
            background-color: #2c2c2e;
            border-radius: 0;
        }
        .hg-theme-default .hg-button {
            background: #555;
            color: white;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }
        .hg-theme-default .hg-button:active {
            background: #444;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center h-screen transition-colors duration-300">

    <div id="main-screen" class="w-full h-full p-6 flex flex-col items-center justify-center text-center bg-white dark:bg-gray-800 shadow-lg max-w-4xl max-h-[800px] rounded-2xl transition-colors duration-300">
        <button id="theme-toggle-button" class="absolute top-6 left-6 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 w-12 h-12 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 transition flex items-center justify-center">
            <i id="theme-icon" class="fas fa-moon text-xl"></i>
        </button>
        <button id="admin-login-button" class="absolute top-6 right-6 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
            <i class="fas fa-user-shield mr-2"></i>Admin
        </button>

        <h1 class="text-5xl font-bold text-gray-800 dark:text-gray-100 mb-4">Package Locker</h1>
        <p class="text-xl text-gray-500 dark:text-gray-400 mb-12">Simple, secure, and self-service package pickup.</p>
        <button id="pickup-package-button" class="bg-blue-600 text-white font-bold py-6 px-12 rounded-2xl text-2xl hover:bg-blue-700 transition transform hover:scale-105 shadow-xl">
            <i class="fas fa-box-open mr-3"></i>
            Pick Up My Package
        </button>
    </div>

    <!-- Modals Container -->
    <div id="modal-container"></div>
    <!-- Virtual Keyboard Container -->
    <div id="keyboard-container" class="simple-keyboard"></div>

    <input type="file" id="csv-file-input" class="hidden" accept=".csv">

    <script>
        // --- CONFIGURATION ---
        const EMAILJS_PUBLIC_KEY = 'cLa8lTnHzamomf5by';
        const EMAILJS_SERVICE_ID = 'service_gyjmvdw';
        const EMAILJS_TEMPLATE_ID = 'template_zwug2z7';

        // --- APPLICATION STATE ---
        let bays = [];

        // --- VIRTUAL KEYBOARD ---
        let Keyboard = window.SimpleKeyboard.default;
        let keyboard;
        let currentInput; // To track which input field is active

        // --- DOM ELEMENTS ---
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const adminLoginButton = document.getElementById('admin-login-button');
        const pickupPackageButton = document.getElementById('pickup-package-button');
        const modalContainer = document.getElementById('modal-container');
        const csvFileInput = document.getElementById('csv-file-input');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState(); // Auto-load from localStorage on startup
            if (EMAILJS_PUBLIC_KEY && EMAILJS_SERVICE_ID) {
                emailjs.init(EMAILJS_PUBLIC_KEY);
            }
        });
        
        // --- STATE MANAGEMENT (localStorage and CSV) ---
        function saveState() {
            try {
                localStorage.setItem('lockerState', JSON.stringify(bays));
            } catch (e) {
                console.error("Failed to save state to localStorage", e);
            }
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem('lockerState');
                if (savedState) {
                    bays = JSON.parse(savedState);
                } else {
                    // Initialize with default state if nothing is saved
                    bays = [
                        { id: 1, occupied: false, customerEmail: null, pickupCode: null },
                        { id: 2, occupied: true, customerEmail: 'demo@example.com', pickupCode: 'DEMO123' },
                        { id: 3, occupied: false, customerEmail: null, pickupCode: null },
                        { id: 4, occupied: false, customerEmail: null, pickupCode: null },
                    ];
                }
            } catch (e) {
                console.error("Failed to load or parse state from localStorage", e);
            }
        }

        function exportToCSV() {
            const headers = "id,occupied,customerEmail,pickupCode";
            const csvContent = bays.map(bay => 
                `${bay.id},${bay.occupied},${bay.customerEmail || ''},${bay.pickupCode || ''}`
            ).join('\n');
            
            const fullCsv = `${headers}\n${csvContent}`;
            const blob = new Blob([fullCsv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `locker_state_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n').slice(1); // Remove header
                const newBays = [];
                try {
                    rows.forEach(row => {
                        if (row.trim() === '') return;
                        const columns = row.split(',');
                        newBays.push({
                            id: parseInt(columns[0]),
                            occupied: columns[1] === 'true',
                            customerEmail: columns[2] || null,
                            pickupCode: columns[3] || null,
                        });
                    });
                    bays = newBays;
                    saveState();
                    showAdminPanel(); // Refresh view
                    showModal("Success", "<p class='dark:text-gray-300'>State successfully imported from CSV.</p>", 3000);
                } catch (err) {
                    showModal("Import Error", "<p class='text-red-500'>Failed to parse CSV file. Please check the format.</p>", 4000);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }


        // --- MODAL MANAGEMENT ---
        function showModal(title, content, autoCloseDelay = 0) {
            closeModal();
            const modalBackdrop = document.createElement('div');
            modalBackdrop.className = 'modal-backdrop';
            modalBackdrop.id = 'modal-backdrop';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">${title}</h2>
                <div id="modal-body">${content}</div>
            `;
            
            modalBackdrop.appendChild(modalContent);
            modalContainer.appendChild(modalBackdrop);

            setTimeout(() => modalBackdrop.classList.add('active'), 10);

            if (autoCloseDelay > 0) {
                setTimeout(closeModal, autoCloseDelay);
            }

            modalBackdrop.addEventListener('click', (e) => {
                if (e.target === modalBackdrop) closeModal();
            });
        }

        function closeModal() {
            const modalBackdrop = document.getElementById('modal-backdrop');
            if (modalBackdrop) {
                modalBackdrop.classList.remove('active');
                modalBackdrop.addEventListener('transitionend', () => modalBackdrop.remove());
            }
        }
        
        // --- THEME MANAGEMENT ---
        function toggleTheme() {
            const htmlEl = document.documentElement;
            htmlEl.classList.toggle('dark');
            const themeIcon = document.getElementById('theme-icon');
            if (htmlEl.classList.contains('dark')) {
                themeIcon.classList.replace('fa-moon', 'fa-sun');
            } else {
                themeIcon.classList.replace('fa-sun', 'fa-moon');
            }
        }

        // --- EVENT LISTENERS ---
        adminLoginButton.addEventListener('click', showAdminLogin);
        pickupPackageButton.addEventListener('click', showPickupScreen);
        themeToggleButton.addEventListener('click', toggleTheme);
        csvFileInput.addEventListener('change', importFromCSV);


        // --- ADMIN FLOW ---
        function showAdminLogin() {
            const content = `
                <p class="mb-4 text-gray-600 dark:text-gray-400">Please enter the admin password to continue.</p>
                <input type="password" id="admin-password" class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg mb-4" placeholder="Password">
                <button id="admin-submit" class="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition">Login</button>
            `;
            showModal('Admin Login', content);

            // --- Show Keyboard ---
            const input = document.getElementById('admin-password');
            setupKeyboard(input);

            document.getElementById('admin-submit').addEventListener('click', verifyAdminPassword);
        }

        function verifyAdminPassword() {
            const password = document.getElementById('admin-password').value;
            if (password === 'admin123') {
                showAdminPanel();
            } else {
                showModal('Error', '<p class="text-red-500">Incorrect password. Please try again.</p>', 3000);
            }
        }
        
        function renderAdminBays() {
            const baysContainer = document.getElementById('admin-bays-container');
            if (!baysContainer) return;
            
            baysContainer.innerHTML = bays.map(bay => {
                const isOccupied = bay.occupied;
                const statusColor = isOccupied ? 'red' : 'green';
                
                let details = '';
                if (isOccupied) {
                    details = `
                        <p class="text-sm text-gray-600 dark:text-gray-300 font-medium">For: <span class="font-normal break-all">${bay.customerEmail}</span></p>
                        <p class="text-sm text-gray-600 dark:text-gray-300 font-medium mt-1">Code: <span class="font-mono text-blue-600 bg-blue-100 dark:text-blue-300 dark:bg-blue-900/50 px-2 py-1 rounded">${bay.pickupCode}</span></p>
                    `;
                }

                return `
                    <div class="border dark:border-gray-700 rounded-xl p-4 bg-white dark:bg-gray-700 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">Bay ${bay.id}</h3>
                            <span class="text-sm font-semibold text-${statusColor}-600 bg-${statusColor}-100 dark:text-${statusColor}-300 dark:bg-${statusColor}-900/50 px-3 py-1 rounded-full">${isOccupied ? 'Occupied' : 'Available'}</span>
                        </div>
                        <div class="min-h-[40px]">${details}</div>
                    </div>
                `;
            }).join('');
        }

        function showAdminPanel() {
            const content = `
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Locker Status</h3>
                    <div id="admin-bays-container" class="bay-grid"></div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button id="deposit-package-btn" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition">Deposit Package</button>
                    <button id="manage-bays-btn" class="bg-gray-600 text-white p-3 rounded-lg hover:bg-gray-700 transition">Manage Bays</button>
                </div>
                <div>
                     <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Data Management</h3>
                     <div class="grid grid-cols-2 gap-4">
                        <button id="import-csv-btn" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition">Import from CSV</button>
                        <button id="export-csv-btn" class="bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition">Export to CSV</button>
                     </div>
                </div>
            `;
            showModal('Admin Panel', content);
            renderAdminBays();

            document.getElementById('deposit-package-btn').addEventListener('click', showDepositScreen);
            document.getElementById('manage-bays-btn').addEventListener('click', showManageBaysScreen);
            document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
            document.getElementById('import-csv-btn').addEventListener('click', () => csvFileInput.click());
        }
        
        function showDepositScreen() {
            const availableBays = bays.filter(bay => !bay.occupied);
            if (availableBays.length === 0) {
                showModal('No Bays Available', '<p class="dark:text-gray-300">All locker bays are currently occupied.</p>', 3000);
                return;
            }

            const bayOptions = availableBays.map(bay => `<option value="${bay.id}">Bay ${bay.id}</option>`).join('');
            const content = `
                <p class="mb-4 text-gray-600 dark:text-gray-400">Select an available bay and enter the customer's email.</p>
                <select id="bay-select" class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg mb-4">${bayOptions}</select>
                <input type="email" id="customer-email" class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg mb-4" placeholder="customer@example.com">
                <button id="submit-deposit" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition">Deposit & Send Code</button>
            `;
            showModal('Deposit Package', content);
            
            // --- Show Keyboard ---
            const input = document.getElementById('customer-email');
            setupKeyboard(input);

            document.getElementById('submit-deposit').addEventListener('click', handleDeposit);
        }

        async function handleDeposit() {
            const selectedBayId = parseInt(document.getElementById('bay-select').value);
            const email = document.getElementById('customer-email').value;

            if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
                showModal("Invalid Email", "<p class='text-red-500'>Please enter a valid email address.</p>", 3000);
                return;
            }

            const pickupCode = `PKG${Date.now().toString().slice(-6)}`;
            const bay = bays.find(b => b.id === selectedBayId);
            
            if (bay) {
                bay.occupied = true;
                bay.customerEmail = email;
                bay.pickupCode = pickupCode;
                saveState();

                showModal('Opening Bay...', `<p class="dark:text-gray-300">Opening Bay ${selectedBayId}. Place the package inside and close the door.</p>`, 0);
                await new Promise(resolve => setTimeout(resolve, 2000));

                const emailSent = await sendEmailWithQRCode(email, pickupCode);
                
                if (emailSent) {
                    showQRCodeModal(pickupCode, email, true);
                } else {
                    showQRCodeModal(pickupCode, email, false);
                }
            }
        }
        
        async function sendEmailWithQRCode(toEmail, pickupCode) {
            if (!EMAILJS_PUBLIC_KEY) {
                 console.warn("EmailJS keys not configured. Skipping email.");
                 return false;
            }

            const canvas = document.createElement('canvas');
            new QRious({ element: canvas, value: pickupCode, size: 256 });
            const qrCodeImage = canvas.toDataURL('image/png');

            const templateParams = { to_email: toEmail, pickup_code: pickupCode, qr_code_image: qrCodeImage };
            
            try {
                showModal("Sending...", `<p class="dark:text-gray-300">Sending pickup code to ${toEmail}</p>`, 0);
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                return true;
            } catch (error) {
                console.error('Failed to send email:', error);
                return false;
            }
        }

        function showQRCodeModal(pickupCode, email, isConfirmation = false) {
            const title = isConfirmation ? 'Deposit Confirmation' : 'Backup Pickup Code';
            const message = isConfirmation
                ? `The following pickup details were successfully sent to ${email}.`
                : 'Since the email could not be sent, please show this QR code to the customer or provide them with the manual code.';

            const content = `
                <p class="mb-4 text-center dark:text-gray-300">${message}</p>
                <div class="flex justify-center mb-4 bg-white p-2 rounded-lg">
                    <canvas id="qr-canvas"></canvas>
                </div>
                <p class="text-center text-2xl font-mono bg-gray-100 dark:bg-gray-700 dark:text-gray-200 p-2 rounded">${pickupCode}</p>
                <p class="text-center text-sm text-gray-500 dark:text-gray-400 mt-2">For: ${email}</p>
                 <button id="qr-close-btn" class="w-full mt-4 bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600 transition">Close & View Dashboard</button>
            `;
            showModal(title, content);
            new QRious({ element: document.getElementById('qr-canvas'), value: pickupCode, size: 200 });
            
            document.getElementById('qr-close-btn').addEventListener('click', () => {
                closeModal();
                showAdminPanel();
            });
        }

        function showManageBaysScreen() {
            const baysContent = bays.map(bay => {
                const isOccupied = bay.occupied;
                const statusColor = isOccupied ? 'red' : 'green';
                const clearButton = isOccupied
                    ? `<button data-bay-id="${bay.id}" class="clear-bay-btn flex-1 bg-red-600 text-white p-2 rounded-lg hover:bg-red-700 transition text-sm">Clear Bay</button>`
                    : '';

                return `
                    <div class="border dark:border-gray-600 rounded-lg p-4 flex flex-col justify-between">
                        <div class="flex justify-between items-center mb-3">
                           <h4 class="font-bold dark:text-gray-100">Bay ${bay.id}</h4>
                           <span class="text-xs font-semibold text-${statusColor}-600 bg-${statusColor}-100 dark:text-${statusColor}-300 dark:bg-${statusColor}-900/50 px-2 py-1 rounded-full">${isOccupied ? 'Occupied' : 'Available'}</span>
                        </div>
                        <div class="flex space-x-2">
                           <button data-bay-id="${bay.id}" class="open-door-btn flex-1 bg-yellow-500 text-black p-2 rounded-lg hover:bg-yellow-600 transition text-sm">Open Door</button>
                           ${clearButton}
                        </div>
                    </div>
                `;
            }).join('');

            const content = `
                <p class="mb-4 text-gray-600 dark:text-gray-400">Manually open a bay for maintenance or clear an occupied bay.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    ${baysContent}
                </div>
            `;
            showModal('Manage Bays', content);

            document.querySelectorAll('.open-door-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const bayId = e.currentTarget.dataset.bayId;
                    showModal('Success', `<p class="dark:text-gray-300">Bay ${bayId} has been opened.</p>`, 3000);
                });
            });

            document.querySelectorAll('.clear-bay-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const bayId = parseInt(e.currentTarget.dataset.bayId);
                    confirmClearBay(bayId);
                });
            });
        }
        
        function confirmClearBay(bayId) {
            const content = `
                <p class="mb-4 text-gray-600 dark:text-gray-400">Are you sure you want to clear Bay ${bayId}? This will mark it as available and delete its pickup code. This action cannot be undone.</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-clear-btn" class="bg-gray-200 dark:bg-gray-600 text-black dark:text-white px-4 py-2 rounded-lg">Cancel</button>
                    <button id="confirm-clear-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg">Yes, Clear Bay</button>
                </div>
            `;
            showModal(`Confirm Clear Bay ${bayId}`, content);

            document.getElementById('cancel-clear-btn').addEventListener('click', showManageBaysScreen);
            document.getElementById('confirm-clear-btn').addEventListener('click', () => handleClearBay(bayId));
        }

        function handleClearBay(bayId) {
            const bay = bays.find(b => b.id === bayId);
            if(bay) {
                bay.occupied = false;
                bay.customerEmail = null;
                bay.pickupCode = null;
            }
            saveState();
            showManageBaysScreen();
        }

        // --- CUSTOMER FLOW ---
        function showPickupScreen() {
            const content = `
                 <p class="mb-4 text-gray-600 dark:text-gray-400">Scan the QR code from your email or enter the code manually.</p>
                 <div id="scanner-placeholder" class="w-64 h-64 bg-gray-200 dark:bg-gray-700 rounded-lg mx-auto mb-4 flex items-center justify-center text-gray-400 dark:text-gray-500">
                    <i class="fas fa-qrcode fa-5x"></i>
                    <p class="absolute mt-24 font-semibold">QR Scanner Placeholder</p>
                 </div>
                 <input type="text" id="pickup-code-input" class="w-full p-3 text-center tracking-widest font-mono border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg mb-4" placeholder="ENTER CODE" autocapitalize="characters">
                 <button id="submit-pickup-code" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition">Submit Code</button>
            `;
            showModal('Pickup Package', content);
            
            // --- Show Keyboard ---
            const input = document.getElementById('pickup-code-input');
            setupKeyboard(input);

            document.getElementById('submit-pickup-code').addEventListener('click', verifyCode);
        }

        function verifyCode() {
            const code = document.getElementById('pickup-code-input').value.trim().toUpperCase();
            const bay = bays.find(b => b.pickupCode === code && b.occupied);

            if (bay) {
                closeModal();
                showModal('Success!', `<p class="dark:text-gray-300">Code accepted. Opening Bay ${bay.id}.</p><p class="dark:text-gray-300">Please collect your package and close the door.</p>`, 5000);
                bay.occupied = false;
                bay.customerEmail = null;
                bay.pickupCode = null;
                saveState();
            } else {
                const input = document.getElementById('pickup-code-input');
                input.classList.add('border-red-500');
                showModal('Invalid Code', '<p class="text-red-500">The code you entered is not valid or has already been used. Please try again.</p>', 4000);
                setTimeout(() => {
                    if (input) input.classList.remove('border-red-500');
                }, 4000);
            }
        }

        // --- KEYBOARD HELPER FUNCTIONS ---
        function setupKeyboard(inputElement) {
            currentInput = inputElement;
            document.getElementById('keyboard-container').style.display = 'block';

            let commonKeyboardOptions = {
                onChange: input => onInputChange(input),
                onKeyPress: button => onKeyPress(button),
                theme: "hg-theme-default",
                mergeDisplay: true,
                display: {
                    '{shift}': 'Shift',
                    '{enter}': 'Enter',
                    '{backspace}': 'âŒ«',
                    '{space}': ' '
                }
            };
            
            let layout = (inputElement.type === 'email') ? 
            {
                'default': [
                    'q w e r t y u i o p',
                    'a s d f g h j k l',
                    '{shift} z x c v b n m . @ {backspace}',
                    '{space} {enter}'
                ],
                'shift': [
                    'Q W E R T Y U I O P',
                    'A S D F G H J K L',
                    '{shift} Z X C V B N M _ - {backspace}',
                    '{space} {enter}'
                ]
            } : 
            {
                'default': [
                    '1 2 3 4 5 6 7 8 9 0',
                    'q w e r t y u i o p',
                    'a s d f g h j k l',
                    '{shift} z x c v b n m {backspace}',
                    '{space} {enter}'
                ],
                'shift': [
                    '! @ # $ % ^ & * ( )',
                    'Q W E R T Y U I O P',
                    'A S D F G H J K L',
                    '{shift} Z X C V B N M {backspace}',
                    '{space} {enter}'
                ]
            };


            keyboard = new Keyboard({
                ...commonKeyboardOptions,
                layout: layout
            });
        }

        function onInputChange(input) {
            currentInput.value = input;
        }

        function onKeyPress(button) {
            if (button === "{shift}" || button === "{lock}") handleShift();
            
            if (button === "{enter}") {
                if (currentInput.id === 'admin-password') verifyAdminPassword();
                if (currentInput.id === 'pickup-code-input') verifyCode();
                if (currentInput.id === 'customer-email') handleDeposit();
                hideKeyboard();
            }
        }

        function handleShift() {
            let currentLayout = keyboard.options.layoutName;
            let shiftToggle = currentLayout === "default" ? "shift" : "default";
            keyboard.setOptions({ layoutName: shiftToggle });
        }

        function hideKeyboard() {
            if (keyboard) {
                keyboard.destroy();
                document.getElementById('keyboard-container').style.display = 'none';
                keyboard = null;
            }
        }
        
        // --- Intercept closeModal to hide the keyboard ---
        // We need a clean way to do this. Let's redefine it.
        const originalCloseModal = closeModal;
        closeModal = function() {
            hideKeyboard();
            originalCloseModal.apply(this, arguments);
        };
    </script>

    <!-- Simple Keyboard JS -->
    <script src="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/index.js"></script>
</body>
</html>
